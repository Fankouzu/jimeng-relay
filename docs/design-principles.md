# 即梦 4.0 API 中转服务设计规范

## 1. 概述

本文档旨在定义即梦 4.0 API 中转服务（Jimeng Relay）的设计原则与编码规范。通过遵循这些原则，我们确保系统具备高性能、高可靠性、易维护性和安全性，能够稳定地作为客户端与火山引擎即梦 API 之间的桥梁。

## 2. 架构设计原则

### 2.1 分层架构
系统采用经典的分层架构，确保各层职责清晰，降低耦合度：
- **Handler 层**：负责处理 HTTP 请求，解析参数，调用 Service 层，并返回响应。严禁在此层编写业务逻辑。
- **Service 层**：核心业务逻辑所在地。负责流程编排、权限校验、限流控制等。
- **Repository 层**：负责数据持久化操作（SQLite/PostgreSQL）。通过接口定义，实现存储介质的可插拔性。
- **Middleware 层**：处理横切关注点，如鉴权（SigV4）、日志审计、Panic 恢复等。

### 2.2 关注点分离 (SoC)
- 鉴权逻辑应独立于业务逻辑，通过中间件实现。
- 并发控制（限流、排队）应封装在独立的组件中，不应散落在 Handler 中。
- 审计记录应作为业务处理的副作用，通过专门的服务异步或同步记录，但不应干扰核心转发流程。

### 2.3 单一职责 (SRP)
- 每个包和结构体应只负责一项明确的功能。例如，`KeyManager` 仅负责 API Key 的并发状态管理，而不负责 Key 的增删改查。

## 3. 模块化设计

### 3.1 包结构
- **cmd/**：程序入口，负责配置加载和依赖注入。
- **internal/**：存放私有代码，防止被外部项目误引用。
- **pkg/**（如有）：存放可供外部引用的通用工具。
- 按照功能模块划分包，如 `handler/relay`、`service/apikey`、`repository/sqlite`。

### 3.2 依赖注入
- 采用构造函数注入依赖。避免使用全局变量或单例模式，以提高代码的可测试性。
- 在 `main.go` 中完成所有组件的初始化和组装。

### 3.3 接口定义
- “接受接口，返回结构体”。
- Repository 层必须定义接口，以便在测试中使用 Mock 实现。
- 接口应尽可能小，遵循接口隔离原则。

## 4. 错误处理策略

### 4.1 错误分类
- **业务错误**：如 `ErrRateLimited`、`ErrAuthFailed`，需要返回给客户端明确的错误码。
- **系统错误**：如数据库连接失败、上游超时，通常返回 500 或 502。
- **验证错误**：参数不合法，返回 400。

### 4.2 错误传播
- 严禁直接返回原始错误。必须使用 `fmt.Errorf("context: %w", err)` 或自定义的错误包装工具，保留错误堆栈并添加上下文信息。
- 在 Handler 层统一进行错误到 HTTP 状态码的映射。

### 4.3 错误恢复
- 必须配置顶层 Panic Recovery 中间件，确保单个请求的崩溃不会导致整个进程退出。
- 审计记录遵循 **Fail-Closed** 策略：如果审计日志记录失败，必须拒绝请求，确保合规性。

## 5. 并发安全原则

### 5.1 锁的使用
- 优先使用 `sync.RWMutex` 区分读写锁，提高并发性能。
- 锁的粒度应尽可能小，严禁在持有锁的情况下执行耗时的 I/O 操作。
- 推荐使用 `defer mu.Unlock()` 确保锁一定会被释放。

### 5.2 Channel 通信
- 使用 Channel 实现信号量（Semaphore）和 FIFO 队列。
- 确保 Channel 的关闭逻辑清晰，避免向已关闭的 Channel 发送数据导致 Panic。

### 5.3 Context 传播
- 所有阻塞操作（网络请求、锁竞争、Channel 等待）必须接受 `context.Context`。
- 必须尊重 `ctx.Done()` 信号，及时释放资源并退出，防止协程泄露。

## 6. API 设计规范

### 6.1 RESTful 设计
- 资源路径清晰，如 `/v1/submit`、`/v1/get-result`。
- 兼容模式：支持通过 `Action` 参数进行路由映射，以适配旧版 SDK。

### 6.2 请求/响应格式
- 统一使用 JSON 格式。
- 响应体结构：
  - 成功：`{"code": 10000, "data": {...}, "message": "success"}`
  - 失败：`{"error": {"code": "ERROR_CODE", "message": "human readable message", "request_id": "..."}}`

### 6.3 版本控制
- 在 URL 中包含版本号（如 `/v1/...`），确保 API 的向后兼容性。

## 7. 代码复用原则

### 7.1 DRY 原则
- 提取通用的 SigV4 签名逻辑到独立模块。
- 数据库迁移逻辑应统一管理，避免在多个地方手动创建表。

### 7.2 共享模块提取
- 客户端和服务端共享的模型定义（如请求/响应结构体）应保持一致，必要时可提取到公共包。

### 7.3 工具函数设计
- 工具函数应是无状态的（Stateless）。
- 避免在工具函数中隐藏复杂的业务逻辑或副作用。
